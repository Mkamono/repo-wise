<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub PKCE 認証テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #218838;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>GitHub PKCE 認証テスト</h1>
    
    <div class="config-section">
        <h3>設定</h3>
        <p><strong>GitHub OAuth App の Client ID を入力してください:</strong></p>
        <input type="text" id="clientId" placeholder="GitHub OAuth App Client ID" style="width: 400px; padding: 8px;">
        <p><small>
            GitHub OAuth App作成方法:<br>
            1. GitHub Settings → Developer settings → OAuth Apps → New OAuth App<br>
            2. Application name: 任意の名前<br>
            3. Homepage URL: http://localhost:3000 (テスト用)<br>
            4. Authorization callback URL: http://localhost:3000/callback (テスト用)
        </small></p>
    </div>

    <div class="container">
        <h3>認証状態</h3>
        <div id="authStatus">未認証</div>
        <button id="loginBtn" onclick="startAuth()">GitHub でログイン</button>
        <button id="logoutBtn" onclick="logout()" style="display: none;">ログアウト</button>
    </div>

    <div class="container">
        <h3>API レスポンス</h3>
        <button id="apiBtn" onclick="callAPI()" disabled>GitHub API テスト</button>
        <pre id="apiResult">認証後にAPIを呼び出せます</pre>
    </div>

    <script src="minimal-oauth-client.js"></script>
    <script>
        let accessToken = localStorage.getItem('github_token');
        let codeVerifier = '';

        // 初期化
        window.onload = function() {
            if (accessToken) {
                showLoggedIn();
            }
            
            // コールバック処理
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                exchangeCodeForToken(code);
            }
        };

        // ランダム文字列生成
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        // SHA256 ハッシュ生成
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(hash)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // 認証開始
        async function startAuth() {
            const clientId = document.getElementById('clientId').value;
            if (!clientId) {
                showError('Client ID を入力してください');
                return;
            }

            try {
                // PKCE パラメータ生成
                codeVerifier = generateRandomString(128);
                const codeChallenge = await sha256(codeVerifier);
                
                // code_verifierをlocalStorageに保存（認証後に使用）
                localStorage.setItem('code_verifier', codeVerifier);
                localStorage.setItem('github_client_id', clientId);
                
                // 認証URL生成
                const params = new URLSearchParams({
                    client_id: clientId,
                    redirect_uri: window.location.origin + window.location.pathname,
                    scope: 'repo user',
                    response_type: 'code',
                    code_challenge: codeChallenge,
                    code_challenge_method: 'S256'
                });

                // GitHub認証ページへ遷移
                window.location.href = `https://github.com/login/oauth/authorize?${params}`;
            } catch (error) {
                showError('認証エラー: ' + error.message);
            }
        }

        // コードをトークンに交換（GitHub Actions Dispatch使用）
        async function exchangeCodeForToken(code) {
            const clientId = document.getElementById('clientId').value || localStorage.getItem('github_client_id');
            
            try {
                // GitHub Actions Dispatch OAuth を使用
                const oauth = new MinimalGitHubOAuth(
                    'YOUR_GITHUB_USERNAME',  // 実際のGitHubユーザー名に変更
                    'YOUR_REPO_NAME',        // 実際のリポジトリ名に変更  
                    localStorage.getItem('github_pat') // Personal Access Token
                );

                const result = await oauth.exchangeCodeForToken(
                    clientId,
                    code,
                    codeVerifier || localStorage.getItem('code_verifier')
                );

                // GitHub Actions Dispatchの結果をそのまま使用
                const data = result;
                
                if (data.access_token) {
                    accessToken = data.access_token;
                    localStorage.setItem('github_token', accessToken);
                    localStorage.setItem('github_client_id', clientId);
                    showLoggedIn();
                    showSuccess('認証成功！');
                    
                    // URLからcodeパラメータを削除
                    const url = new URL(window.location);
                    url.searchParams.delete('code');
                    window.history.replaceState({}, document.title, url);
                } else {
                    showError('トークン取得エラー: ' + JSON.stringify(data));
                }
            } catch (error) {
                showError('トークン交換エラー: ' + error.message);
            }
        }

        // GitHub API 呼び出し
        async function callAPI() {
            if (!accessToken) {
                showError('認証が必要です');
                return;
            }

            try {
                // ユーザー情報取得
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                // リポジトリ一覧取得
                const reposResponse = await fetch('https://api.github.com/user/repos?per_page=5', {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                const userData = await userResponse.json();
                const reposData = await reposResponse.json();

                const result = {
                    user: {
                        login: userData.login,
                        name: userData.name,
                        public_repos: userData.public_repos
                    },
                    repositories: reposData.map(repo => ({
                        name: repo.name,
                        full_name: repo.full_name,
                        private: repo.private
                    }))
                };

                document.getElementById('apiResult').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                showError('API呼び出しエラー: ' + error.message);
            }
        }

        // ログアウト
        function logout() {
            localStorage.removeItem('github_token');
            localStorage.removeItem('github_client_id');
            accessToken = null;
            showLoggedOut();
            document.getElementById('apiResult').textContent = '認証後にAPIを呼び出せます';
        }

        // UI更新
        function showLoggedIn() {
            document.getElementById('authStatus').innerHTML = '<span class="success">認証済み</span>';
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('apiBtn').disabled = false;
        }

        function showLoggedOut() {
            document.getElementById('authStatus').innerHTML = '未認証';
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('apiBtn').disabled = true;
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 5000);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            document.body.insertBefore(div, document.body.firstChild);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>